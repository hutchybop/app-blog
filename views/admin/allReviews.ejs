<% layout('layouts/boilerplate') %>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>All Reviews Management</h3>
                    <div>
                        <a href="/admin/dashboard" class="btn btn-secondary">Back to Dashboard</a>
                        <a href="/admin/flagged-reviews" class="btn btn-warning">Flagged Reviews</a>
                    </div>
                </div>
                <div class="card-body">
                    <% if (allReviews.length === 0) { %>
                        <div class="alert alert-info">
                            <h4>No reviews found</h4>
                            <p>There are currently no reviews in the system.</p>
                        </div>
                    <% } else { %>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th>
                                        <th>Author</th>
                                        <th>Post</th>
                                        <th>Review Content</th>
                                        <th>Status</th>
                                        <th>Spam Score</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% allReviews.forEach(review => { %>
                                        <tr>
                                            <td><%= review.createdAt ? review.createdAt.toLocaleDateString() : 'N/A' %></td>
                                            <td>
                                                <% if (review.author && review.author._id.toString() === "618ae270defe900f7f2980d5") { %>
                                                    <span class="badge bg-secondary">Anonymous</span>
                                                <% } else if (review.author) { %>
                                                    <div>
                                                        <strong><%= review.author.username %></strong>
                                                        <% if (review.author.email) { %>
                                                            <br><small class="text-muted"><%= review.author.email %></small>
                                                        <% } %>
                                                    </div>
                                                <% } else { %>
                                                    <span class="badge bg-danger">Unknown</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (review.blogIM) { %>
                                                    <a href="/blogim/<%= review.blogIM._id %>" target="_blank">
                                                        <%= review.blogIM.title %>
                                                    </a>
                                                <% } else { %>
                                                    <span class="text-muted">Post not found</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <div class="review-content" style="max-width: 300px; word-wrap: break-word;">
                                                    <%= review.body.length > 100 ? review.body.substring(0, 100) + '...' : review.body %>
                                                </div>
                                            </td>
                                            <td>
                                                <% if (review.isFlagged) { %>
                                                    <span class="badge bg-danger">Flagged</span>
                                                    <% if (review.flagReason) { %>
                                                        <br><small class="text-muted"><%= review.flagReason %></small>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="badge bg-success">Approved</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (review.spamScore > 0) { %>
                                                    <span class="badge bg-<%= review.spamScore >= 10 ? 'danger' : review.spamScore >= 5 ? 'warning' : 'info' %>">
                                                        <%= review.spamScore %>
                                                    </span>
                                                <% } else { %>
                                                    <span class="text-muted">0</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <% if (review.isFlagged) { %>
                                                        <form action="/admin/flagged-reviews/<%= review._id %>/approve" method="POST" style="display: inline;">
                                                            <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Approve this review?')">
                                                                <i class="fas fa-check"></i> Approve
                                                            </button>
                                                        </form>
                                                    <% } %>
                                                    
                                                    <!-- Delete with reason modal trigger -->
                                                    <button type="button" class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteModal<%= review._id %>">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </div>

                                                <!-- Delete Confirmation Modal -->
                                                <div class="modal fade" id="deleteModal<%= review._id %>" tabindex="-1">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title">Delete Review</h5>
                                                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                                            </div>
                                                            <form action="/admin/all-reviews/<%= review._id %>/delete" method="POST">
                                                                <div class="modal-body">
                                                                    <p>Are you sure you want to delete this review?</p>
                                                                    
                                                                    <div class="mb-3">
                                                                        <label for="reason<%= review._id %>" class="form-label">Reason for deletion (will be emailed to user if not anonymous):</label>
                                                                        <textarea class="form-control" id="reason<%= review._id %>" name="reason" rows="3" placeholder="Enter reason for deletion..."></textarea>
                                                                    </div>
                                                                    
                                                                    <div class="alert alert-info">
                                                                        <strong>Review Content:</strong><br>
                                                                        "<%= review.body %>"
                                                                    </div>
                                                                    
                                                                    <% if (review.author && review.author._id.toString() !== "618ae270defe900f7f2980d5") { %>
                                                                        <div class="alert alert-warning">
                                                                            <i class="fas fa-envelope"></i> An email will be sent to <strong><%= review.author.username %></strong> (<%= review.author.email %>)
                                                                        </div>
                                                                    <% } else { %>
                                                                        <div class="alert alert-secondary">
                                                                            <i class="fas fa-user-secret"></i> This is an anonymous review - no email will be sent
                                                                        </div>
                                                                    <% } %>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                                                                    <button type="submit" class="btn btn-danger">Delete Review</button>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                Total Reviews: <%= allReviews.length %> | 
                                Flagged: <%= allReviews.filter(r => r.isFlagged).length %> | 
                                Approved: <%= allReviews.filter(r => !r.isFlagged).length %>
                            </small>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .review-content {
        font-size: 0.9em;
        line-height: 1.4;
    }
    
    .table th {
        border-top: none;
    }
    
    .badge {
        font-size: 0.8em;
    }
    
    .btn-group .btn {
        margin-right: 5px;
    }
    
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
</style>